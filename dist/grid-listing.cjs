"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const ee=(s,l,o,M,n,a)=>{const u=Math.max(1,Math.ceil((s+n)/(o*a+n))),I=Math.max(u,Math.floor((s+n)/(o/a+n))),p=Math.max(1,Math.ceil((l+n)/(M*a+n))),T=Math.max(p,Math.floor((l+n)/(M/a+n))),y=n>0?Math.floor(s/n)+1:Number.POSITIVE_INFINITY,B=n>0?Math.floor(l/n)+1:Number.POSITIVE_INFINITY,L=Math.max(1,Math.floor(s)),g=Math.max(1,Math.floor(l)),R=Math.min(I,y,L),f=Math.min(T,B,g);return{cMin:u,cMax:R,rMin:p,rMax:f}},q=(s,l,o,M,n,a={})=>{const u=a.weightSize??1,I=a.weightAR??1,p=a.alpha??1.5,T=o/M,y=ee(s,l,o,M,n,p),B=1,L=1,g=Math.min(y.cMax,a.maxCols??Number.POSITIVE_INFINITY),R=Math.min(y.rMax,a.maxRows??Number.POSITIVE_INFINITY);let f=null;const E=(e,h)=>{if(e<B||h<L||e>g||h>R)return;const S=s-(e-1)*n,x=l-(h-1)*n;if(S<=0||x<=0)return;const b=S/e,m=x/h;if(a.integerBlockSize&&(!Number.isInteger(b)||!Number.isInteger(m))||b<o/p||b>o*p||m<M/p||m>M*p)return;const k=Math.hypot((b-o)/o,(m-M)/M),P=Math.abs(b/m-T)/T,N=u*k+I*P;(!f||N<f.score)&&(f={width:b,height:m,cols:e,rows:h,score:N,sizeError:k,arError:P})};for(let e=y.cMin;e<=g;e++){const h=s-(e-1)*n;if(h<=0)break;const S=h/e;if(S<o/p||S>o*p)continue;const x=(l+n)/(n+S/T),b=new Set;for(let m=-2;m<=2;m++){const k=Math.round(x+m);k>=L&&k<=R&&b.add(k)}b.add(y.rMin),b.add(R);for(const m of b)E(e,m)}if(!f)for(let e=y.cMin;e<=g;e++)for(let h=y.rMin;h<=R;h++)E(e,h);if(!f)throw new Error("No feasible grid found with given settings/tolerance.");return f},te=(s,l,o,M,n)=>{const a=Math.max(1,Math.round(s/o)),u=Math.max(1,Math.round(l/M)),I=s-n*Math.max(0,a-1),p=l-n*Math.max(0,u-1),T=I/a,y=p/u;return{width:T,height:y,cols:a,rows:u}};function oe(){const s=new Map;return{on:(n,a)=>{let u=s.get(n);return u||s.set(n,u=new Set),u.add(a),()=>u.delete(a)},emit:(n,a)=>{const u=s.get(n);u&&[...u].forEach(I=>I(a))},clear:()=>s.clear()}}function ne(s){const l=oe(),o=s.gridEl,M=s.measureViewportEl??null,n=s.desiredBlockSize??{width:400,height:300},a=s.gap??10,u=s.fadeOutDurationMs??200,I=s.staggerStepMs??75,p=s.fadeStaggerStepMs??50,T=s.initialResizeDelayFrames??2,y=s.initialScrollDelayMs??1750,B=s.additionalSpacerRows??!1;let L=[],g=!1,R=!1,f=null,E=null,e,h=0,S,x=null,b=100,m=!1;function k(){H(()=>Y())}function P(){const t=document.documentElement.style;t.setProperty("--block-gap",`${a}px`),t.setProperty("--fade-out-duration",`${u}ms`);const c=Math.max(0,y-250);t.setProperty("--header-fade-delay",`${c}ms`)}function N(t,d){if(t<=0){d();return}requestAnimationFrame(()=>N(t-1,d))}function C(t,d){const c=e?.cols||-1,i=e?.rows||-1;e=q(t,d,n.width,n.height,a),h=1;const r=document.documentElement.style;r.setProperty("--block-width",`${e.width}px`),r.setProperty("--block-height",`${e.height}px`),r.setProperty("--cols",String(e.cols)),r.setProperty("--rows",String(e.rows)),r.setProperty("--block-gap",`${a}px`),r.setProperty("--header-row",`${h}`),(c!==e?.cols||i!==e?.rows)&&l.emit("grid:layout:change",{cols:e.cols,rows:e.rows})}function D(){if(!e)return;o.innerHTML="";const t=document.createElement("div");t.className="row-spacer col-0",o.appendChild(t),L.forEach((c,i)=>{const r=Math.floor(i/e.cols),v=i%e.cols,w=j(c);w.dataset.row=`${r}`,w.dataset.column=`${v}`,w.classList.add(`row-${r}`),w.classList.add(`col-${v}`);const z=(r%2===0?v:e.cols-1-v)*I,W=i*p;w.style.transitionDelay=`${z}ms`,w.style.setProperty("--fade-delay",`${W}ms`),w.classList.add("fade-in"),o.appendChild(w)});let d=Math.ceil(L.length/e.cols)+1;if(B){const c=e.rows-(h+1),i=Math.max(0,c-1);for(let r=0;r<i;r++){const v=document.createElement("div");v.className=`row-spacer col-${r+d}`,o.appendChild(v)}d+=i}for(let c=0;c<d;c++){const i=document.createElement("div");i.className="snap-block",i.dataset.row=`${c}`,i.style.top=`${c*(e.height+a)}px`,o.appendChild(i)}l.emit("grid:rebuild",e),m=!1}function j(t){const d=t.title,i=(Array.isArray(t.thumbnails)?t.thumbnails:[])[0],r=(t.tags||[]).sort((w,O)=>w.localeCompare(O)),v=document.createElement("div");return v.className="block",v.innerHTML=`
      ${i?`<div class="media"><img class="thumb" src="${i}" alt="${d}"></div>`:""}
      <div class="content block-border">
        <div class="info">
          <h3>${d}</h3>
          </div>
          <div class="tags">
            ${r.map(w=>`<div class="tag" data-tag="${w}">${w}</div>`).join("")}
          </div>
      </div>
      <svg class="checker-border" xmlns="http://www.w3.org/2000/svg">
        <rect class="dash black" />
        <rect class="dash white" />
      </svg>
    `,t.href&&v.addEventListener("click",()=>{window.location.href=t.href}),v}function A(){const t=e.height+a,d=Math.round(o.scrollTop/t),c=d+e.rows-2,i=d+h;return{aboveHeader:i-1>=d&&i-1<=c?i-1:void 0,belowHeader:i>=d&&i<=c?i:void 0}}function U(){$(),g=!0,setTimeout(()=>{const t=A();l.emit("initial:scroll:end",t)},500)}function V(){m||l.emit("scroll:start",void 0),m=!0,$()}function F(){if(m){const t=A();l.emit("scroll:end",t)}m=!1}function G(){x&&window.clearTimeout(x),x=window.setTimeout(()=>{F()},b)}function Y(){const t=M?.getBoundingClientRect();if(!t){console.warn("[grid] measureViewport element not found");return}C(t.width,t.height),D(),g&&$(),o&&o.scrollHeight>o.clientHeight&&(C(o.clientWidth,t.height),D(),g&&$()),R||(R=!0,document.body.classList.add("layout-ready")),g&&setTimeout(()=>{l.emit("initial:scroll:end",A())},500)}function _(){const t=M?.getBoundingClientRect();t&&(o.hasChildNodes()&&(o.innerHTML="",l.emit("grid:clear",void 0)),C(t.width,t.height),f!==null&&window.clearTimeout(f),f=window.setTimeout(()=>{D(),g&&$(),o&&o.scrollHeight>o.clientHeight&&(C(o.clientWidth,t.height),D(),g&&$()),f=null,g&&setTimeout(()=>{l.emit("initial:scroll:end",A())},500)},400))}function $(){if(!e)return;const t=e.height+a,c=Math.round(o.scrollTop/t)+h;o.querySelectorAll(".block").forEach(r=>{parseInt(r.dataset.row||"0",10)<c?r.classList.add("above-header"):r.classList.remove("above-header")})}function H(t){const d=Array.from(o.querySelectorAll(".block"));if(d.length===0){t();return}E!==null&&(window.clearTimeout(E),E=null);let c=0;d.forEach(r=>{const v=parseInt(r.dataset.row||"0",10),w=parseInt(r.dataset.column||"0",10),z=(v%2===0?w:e.cols-1-w)*p;r.style.setProperty("--fade-delay",`${z}ms`),r.classList.add("fade-out"),z>c&&(c=z)});const i=c+u+20;E=window.setTimeout(()=>{E=null,t()},i)}function J(){P(),o.addEventListener("scroll",V,{passive:!0}),window.addEventListener("resize",_),window.addEventListener("popstate",k),S="onscrollend"in window,S?o.addEventListener("scrollend",F):o.addEventListener("scroll",G,{passive:!0})}function K(){l.clear(),o.removeEventListener("scroll",V),window.removeEventListener("resize",_),window.removeEventListener("popstate",k),S?o.removeEventListener("scrollend",F):(x&&window.clearTimeout(x),o.removeEventListener("scroll",G)),f!==null&&(window.clearTimeout(f),f=null),E!==null&&(window.clearTimeout(E),E=null)}function Q(t){L=t,N(T,()=>Y()),window.setTimeout(U,y)}function X(){return e}return{init:J,destroy:K,setItems:Q,events:l,getLayout:X}}exports.createGridList=ne;exports.findBestBlockSize=q;exports.findNaiveBlockSize=te;

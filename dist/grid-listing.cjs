"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const te=(r,i,t,w,s,a)=>{const d=Math.max(1,Math.ceil((r+s)/(t*a+s))),T=Math.max(d,Math.floor((r+s)/(t/a+s))),M=Math.max(1,Math.ceil((i+s)/(w*a+s))),R=Math.max(M,Math.floor((i+s)/(w/a+s))),v=s>0?Math.floor(r/s)+1:Number.POSITIVE_INFINITY,N=s>0?Math.floor(i/s)+1:Number.POSITIVE_INFINITY,$=Math.max(1,Math.floor(r)),y=Math.max(1,Math.floor(i)),k=Math.min(T,v,$),m=Math.min(R,N,y);return{cMin:d,cMax:k,rMin:M,rMax:m}},q=(r,i,t,w,s,a={})=>{const d=a.weightSize??1,T=a.weightAR??1,M=a.alpha??1.5,R=t/w,v=te(r,i,t,w,s,M),N=1,$=1,y=Math.min(v.cMax,a.maxCols??Number.POSITIVE_INFINITY),k=Math.min(v.rMax,a.maxRows??Number.POSITIVE_INFINITY);let m=null;const S=(e,h)=>{if(e<N||h<$||e>y||h>k)return;const x=r-(e-1)*s,I=i-(h-1)*s;if(x<=0||I<=0)return;const g=x/e,f=I/h;if(a.integerBlockSize&&(!Number.isInteger(g)||!Number.isInteger(f))||g<t/M||g>t*M||f<w/M||f>w*M)return;const L=Math.hypot((g-t)/t,(f-w)/w),P=Math.abs(g/f-R)/R,z=d*L+T*P;(!m||z<m.score)&&(m={width:g,height:f,cols:e,rows:h,score:z,sizeError:L,arError:P})};for(let e=v.cMin;e<=y;e++){const h=r-(e-1)*s;if(h<=0)break;const x=h/e;if(x<t/M||x>t*M)continue;const I=(i+s)/(s+x/R),g=new Set;for(let f=-2;f<=2;f++){const L=Math.round(I+f);L>=$&&L<=k&&g.add(L)}g.add(v.rMin),g.add(k);for(const f of g)S(e,f)}if(!m)for(let e=v.cMin;e<=y;e++)for(let h=v.rMin;h<=k;h++)S(e,h);if(!m)throw new Error("No feasible grid found with given settings/tolerance.");return m},oe=(r,i,t,w,s)=>{const a=Math.max(1,Math.round(r/t)),d=Math.max(1,Math.round(i/w)),T=r-s*Math.max(0,a-1),M=i-s*Math.max(0,d-1),R=T/a,v=M/d;return{width:R,height:v,cols:a,rows:d}};function ne(){const r=new Map;return{on:(s,a)=>{let d=r.get(s);return d||r.set(s,d=new Set),d.add(a),()=>d.delete(a)},emit:(s,a)=>{const d=r.get(s);d&&[...d].forEach(T=>T(a))},clear:()=>r.clear()}}function se(r){const i=ne(),t=r.gridEl,w=r.measureViewportEl??null,s=r.desiredBlockSize??{width:400,height:300},a=r.gap??10,d=r.fadeOutDurationMs??200,T=r.staggerStepMs??75,M=r.fadeStaggerStepMs??50,R=r.initialResizeDelayFrames??2,v=r.initialScrollDelayMs??1750,N=r.additionalSpacerRows??!1;let $=[],y=!1,k=!1,m=null,S=null,e,h=0,x,I=null,g=100,f=!1;function L(){U(()=>Y())}function P(){const o=document.documentElement.style;o.setProperty("--block-gap",`${a}px`),o.setProperty("--fade-out-duration",`${d}ms`);const u=Math.max(0,v-250);o.setProperty("--header-fade-delay",`${u}ms`)}function z(o,c){if(o<=0){c();return}requestAnimationFrame(()=>z(o-1,c))}function C(o,c){const u=e?.cols||-1,l=e?.rows||-1;e=q(o,c,s.width,s.height,a),h=1;const n=document.documentElement.style;n.setProperty("--block-width",`${e.width}px`),n.setProperty("--block-height",`${e.height}px`),n.setProperty("--cols",String(e.cols)),n.setProperty("--rows",String(e.rows)),n.setProperty("--block-gap",`${a}px`),n.setProperty("--header-row",`${h}`),(u!==e?.cols||l!==e?.rows)&&i.emit("grid:layout:change",{cols:e.cols,rows:e.rows})}function D(){if(!e)return;t.innerHTML="";const o=document.createElement("div");o.className="row-spacer col-0",t.appendChild(o);const c=r.renderCard??j;$.forEach((l,n)=>{const E=Math.floor(n/e.cols),p=n%e.cols,b=c(l);b.dataset.row=`${E}`,b.dataset.column=`${p}`,b.classList.add(`row-${E}`),b.classList.add(`col-${p}`);const W=(E%2===0?p:e.cols-1-p)*T,ee=n*M;b.style.transitionDelay=`${W}ms`,b.style.setProperty("--fade-delay",`${ee}ms`),b.classList.add("fade-in"),t.appendChild(b)});let u=Math.ceil($.length/e.cols)+1;if(N){const l=e.rows-(h+1),n=Math.max(0,l-1);for(let E=0;E<n;E++){const p=document.createElement("div");p.className=`row-spacer col-${E+u}`,t.appendChild(p)}u+=n}for(let l=0;l<u;l++){const n=document.createElement("div");n.className="snap-block",n.dataset.row=`${l}`,n.style.top=`${l*(e.height+a)}px`,t.appendChild(n)}i.emit("grid:rebuild",e),f=!1}function j(o){const c=o.title??"",u=o.thumbnail,l=(o.tags||[]).sort((p,b)=>p.localeCompare(b)),n=document.createElement("div");n.className="block";const E=c?`<div class="info"><h3>${c}</h3></div>`:"";return n.innerHTML=`
      ${u?`<div class="media"><img class="thumb" src="${u}" alt="${c}"></div>`:""}
      <div class="content block-border">
        ${E}
        <div class="tags">
          ${l.map(p=>`<div class="tag" data-tag="${p}">${p}</div>`).join("")}
        </div>
      </div>
      <svg class="checker-border" xmlns="http://www.w3.org/2000/svg">
        <rect class="dash black" />
        <rect class="dash white" />
      </svg>
    `,o.href&&n.addEventListener("click",()=>{window.location.href=o.href}),n}function F(){const o=e.height+a,c=Math.round(t.scrollTop/o),u=c+e.rows-2,l=c+h;return{aboveHeader:l-1>=c&&l-1<=u?l-1:void 0,belowHeader:l>=c&&l<=u?l:void 0}}function H(){B(),y=!0,setTimeout(()=>{const o=F();i.emit("initial:scroll:end",o)},500)}function V(){f||i.emit("scroll:start",void 0),f=!0,B()}function O(){if(f){const o=F();i.emit("scroll:end",o)}f=!1}function G(){I&&window.clearTimeout(I),I=window.setTimeout(()=>{O()},g)}function Y(){const o=w?.getBoundingClientRect();if(!o){console.warn("[grid] measureViewport element not found");return}C(o.width,o.height),D(),y&&B(),t&&t.scrollHeight>t.clientHeight&&(C(t.clientWidth,o.height),D(),y&&B()),k||(k=!0,document.body.classList.add("layout-ready")),y&&setTimeout(()=>{i.emit("initial:scroll:end",F())},500)}function _(){const o=w?.getBoundingClientRect();o&&(t.hasChildNodes()&&(t.innerHTML="",i.emit("grid:clear",void 0)),C(o.width,o.height),m!==null&&window.clearTimeout(m),m=window.setTimeout(()=>{D(),y&&B(),t&&t.scrollHeight>t.clientHeight&&(C(t.clientWidth,o.height),D(),y&&B()),m=null,y&&setTimeout(()=>{i.emit("initial:scroll:end",F())},500)},400))}function B(){if(!e)return;const o=e.height+a,u=Math.round(t.scrollTop/o)+h;t.querySelectorAll(".block").forEach(n=>{parseInt(n.dataset.row||"0",10)<u?n.classList.add("above-header"):n.classList.remove("above-header")})}function U(o){const c=Array.from(t.querySelectorAll(".block"));if(c.length===0){o();return}S!==null&&(window.clearTimeout(S),S=null);let u=0;c.forEach(n=>{const E=parseInt(n.dataset.row||"0",10),p=parseInt(n.dataset.column||"0",10),A=(E%2===0?p:e.cols-1-p)*M;n.style.setProperty("--fade-delay",`${A}ms`),n.classList.add("fade-out"),A>u&&(u=A)});const l=u+d+20;S=window.setTimeout(()=>{S=null,o()},l)}function J(){P(),t.addEventListener("scroll",V,{passive:!0}),window.addEventListener("resize",_),window.addEventListener("popstate",L),x="onscrollend"in window,x?t.addEventListener("scrollend",O):t.addEventListener("scroll",G,{passive:!0})}function K(){i.clear(),t.removeEventListener("scroll",V),window.removeEventListener("resize",_),window.removeEventListener("popstate",L),x?t.removeEventListener("scrollend",O):(I&&window.clearTimeout(I),t.removeEventListener("scroll",G)),m!==null&&(window.clearTimeout(m),m=null),S!==null&&(window.clearTimeout(S),S=null)}function Q(o){$=o,z(R,()=>Y()),window.setTimeout(H,v)}function X(){return e}return{init:J,destroy:K,setItems:Q,events:i,getLayout:X}}exports.createGridList=se;exports.findBestBlockSize=q;exports.findNaiveBlockSize=oe;

"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const it=(a,h,e,p,n,l)=>{const i=Math.max(1,Math.ceil((a+n)/(e*l+n))),x=Math.max(i,Math.floor((a+n)/(e/l+n))),y=Math.max(1,Math.ceil((h+n)/(p*l+n))),T=Math.max(y,Math.floor((h+n)/(p/l+n))),b=n>0?Math.floor(a/n)+1:Number.POSITIVE_INFINITY,N=n>0?Math.floor(h/n)+1:Number.POSITIVE_INFINITY,P=Math.max(1,Math.floor(a)),L=Math.max(1,Math.floor(h)),k=Math.min(x,b,P),u=Math.min(T,N,L);return{cMin:i,cMax:k,rMin:y,rMax:u}},W=(a,h,e,p,n,l={})=>{const i=l.weightSize??1,x=l.weightAR??1,y=l.alpha??1.5,T=e/p,b=it(a,h,e,p,n,y),N=1,P=1,L=Math.min(b.cMax,l.maxCols??Number.POSITIVE_INFINITY),k=Math.min(b.rMax,l.maxRows??Number.POSITIVE_INFINITY);let u=null;const R=(c,M)=>{if(c<N||M<P||c>L||M>k)return;const g=a-(c-1)*n,S=h-(M-1)*n;if(g<=0||S<=0)return;const r=g/c,f=S/M;if(l.integerBlockSize&&(!Number.isInteger(r)||!Number.isInteger(f))||r<e/y||r>e*y||f<p/y||f>p*y)return;const I=Math.hypot((r-e)/e,(f-p)/p),$=Math.abs(r/f-T)/T,B=i*I+x*$;(!u||B<u.score)&&(u={width:r,height:f,cols:c,rows:M,score:B,sizeError:I,arError:$})};for(let c=b.cMin;c<=L;c++){const M=a-(c-1)*n;if(M<=0)break;const g=M/c;if(g<e/y||g>e*y)continue;const S=(h+n)/(n+g/T),r=new Set;for(let f=-2;f<=2;f++){const I=Math.round(S+f);I>=P&&I<=k&&r.add(I)}r.add(b.rMin),r.add(k);for(const f of r)R(c,f)}if(!u)for(let c=b.cMin;c<=L;c++)for(let M=b.rMin;M<=k;M++)R(c,M);if(!u)throw new Error("No feasible grid found with given settings/tolerance.");return u},ct=(a,h,e,p,n)=>{const l=Math.max(1,Math.round(a/e)),i=Math.max(1,Math.round(h/p)),x=a-n*Math.max(0,l-1),y=h-n*Math.max(0,i-1),T=x/l,b=y/i;return{width:T,height:b,cols:l,rows:i}};function dt(){const a=new Map;return{on:(n,l)=>{let i=a.get(n);return i||a.set(n,i=new Set),i.add(l),()=>i.delete(l)},emit:(n,l)=>{const i=a.get(n);i&&[...i].forEach(x=>x(l))},clear:()=>a.clear()}}function ut(a){const h=dt(),e=a.gridEl,p=a.headerEl??null,n=a.measureViewportEl??null,l=a.desiredBlockSize??{width:400,height:300},i=a.gap??10,x=a.fadeOutDurationMs??200,y=a.staggerStepMs??75,T=a.fadeStaggerStepMs??50,b=a.initialResizeDelayFrames??2,N=a.initialScrollDelayMs??1750,P=a.filterScrollDelayMs??400;let L=[],k=[];const u=new Set;let R=null,c=!1,M=!1,g=null,S=null,r,f=0,I,$=null,B=100,D=!1;function G(){Z(),q(),X(()=>U())}function tt(){const t=document.documentElement.style;t.setProperty("--block-gap",`${i}px`),t.setProperty("--fade-out-duration",`${x}ms`);const s=Math.max(0,N-250);t.setProperty("--header-fade-delay",`${s}ms`)}function Y(t,o){if(t<=0){o();return}requestAnimationFrame(()=>Y(t-1,o))}function C(t,o){r=W(t,o,l.width,l.height,i),f=1;const s=document.documentElement.style;s.setProperty("--block-width",`${r.width}px`),s.setProperty("--block-height",`${r.height}px`),s.setProperty("--cols",String(r.cols)),s.setProperty("--rows",String(r.rows)),s.setProperty("--block-gap",`${i}px`),s.setProperty("--header-row",`${f}`)}function A(){if(!r)return;e.innerHTML="";const t=document.createElement("div");t.className="row-spacer col-0",e.appendChild(t);const o=L.filter(m=>u.size===0?!0:(m.tags||[]).some(v=>u.has(v)));o.forEach((m,d)=>{const v=Math.floor(d/r.cols),w=d%r.cols,E=et(m);E.dataset.row=`${v}`,E.dataset.column=`${w}`,E.classList.add(`row-${v}`),E.classList.add(`col-${w}`);const rt=(v%2===0?w:r.cols-1-w)*y,lt=d*T;E.style.transitionDelay=`${rt}ms`,E.style.setProperty("--fade-delay",`${lt}ms`),E.classList.add("fade-in"),e.appendChild(E)});const s=Math.ceil(o.length/r.cols)+1;for(let m=0;m<s;m++){const d=document.createElement("div");d.className="snap-block",d.dataset.row=`${m}`,d.style.top=`${m*(r.height+i)}px`,e.appendChild(d)}}function et(t){const o=t.title,m=(Array.isArray(t.thumbnails)?t.thumbnails:[])[0],d=(t.tags||[]).sort((w,E)=>w.localeCompare(E)),v=document.createElement("div");return v.className="block",v.innerHTML=`
      ${m?`<div class="media"><img class="thumb" src="${m}" alt="${o}"></div>`:""}
      <div class="content block-border">
        <div class="info">
          <h3>${o}</h3>
        </div>
        <div class="tags">
          ${d.map(w=>`<button class="tag${u.has(w)?" active":""}" data-tag="${w}">${w}</button>`).join("")}
        </div>
      </div>
      <svg class="checker-border" xmlns="http://www.w3.org/2000/svg">
        <rect class="dash black" />
        <rect class="dash white" />
      </svg>
    `,t.href&&v.addEventListener("click",()=>{window.location.href=t.href}),v.querySelectorAll(".tag").forEach(w=>{w.addEventListener("click",E=>{E.preventDefault(),E.stopPropagation();const F=w.getAttribute("data-tag");F&&Q(F)})}),v}function _(){const t=r.height+i,s=Math.round(e.scrollTop/t)+f;return{aboveHeader:s-1,belowHeader:s+1}}function j(){z(),c=!0,setTimeout(()=>{const t=_();h.emit("initial:scroll:end",t)},500)}function H(){D||h.emit("scroll:start",void 0),D=!0,z()}function V(){if(D){const t=_();h.emit("scroll:end",t)}D=!1}function J(){$&&window.clearTimeout($),$=window.setTimeout(()=>{V()},B)}function U(){const t=n?.getBoundingClientRect();if(!t){console.warn("[grid] measureViewport element not found");return}C(t.width,t.height),A(),c&&z(),e&&e.scrollHeight>e.clientHeight&&(C(e.clientWidth,t.height),A(),c&&z()),M||(M=!0,document.body.classList.add("layout-ready"))}function K(){const t=n?.getBoundingClientRect();if(!t)return;C(t.width,t.height),e.innerHTML="";const o=document.createElement("div");o.className="row-spacer col-0",e.appendChild(o),g!==null&&window.clearTimeout(g),g=window.setTimeout(()=>{A(),c&&z(),e&&e.scrollHeight>e.clientHeight&&(C(e.clientWidth,t.height),A(),c&&z()),g=null},400)}function z(){if(!r)return;const t=r.height+i,s=Math.round(e.scrollTop/t)+f;e.querySelectorAll(".block").forEach(d=>{parseInt(d.dataset.row||"0",10)<s?d.classList.add("above-header"):d.classList.remove("above-header")})}function q(){R&&(R.innerHTML="",k.forEach(t=>{const o=document.createElement("button");o.type="button",o.className="tag",o.textContent=t,o.dataset.tag=t,u.has(t)&&o.classList.add("active"),o.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),Q(t)}),R.appendChild(o)}))}function Q(t){u.has(t)?u.delete(t):u.add(t),q(),c=!1,X(()=>U()),window.setTimeout(j,P),ot()}function X(t){const o=Array.from(e.querySelectorAll(".block"));if(o.length===0){t();return}S!==null&&(window.clearTimeout(S),S=null);let s=0;o.forEach(d=>{const v=parseInt(d.dataset.row||"0",10),w=parseInt(d.dataset.column||"0",10),O=(v%2===0?w:r.cols-1-w)*T;d.style.setProperty("--fade-delay",`${O}ms`),d.classList.add("fade-out"),O>s&&(s=O)});const m=s+x+20;S=window.setTimeout(()=>{S=null,t()},m)}function ot(){const t=new URLSearchParams(location.search),o=Array.from(u);o.length?t.set("tags",o.join(",")):t.delete("tags");const s=t.toString(),m=s?`${location.pathname}?${s}`:location.pathname;history.pushState(null,"",m)}function Z(){u.clear();const o=new URLSearchParams(location.search).get("tags");o&&o.split(",").filter(Boolean).forEach(s=>u.add(s))}function nt(){p&&(R=document.createElement("div"),R.className="tags",p.appendChild(R)),tt(),e.addEventListener("scroll",H,{passive:!0}),window.addEventListener("resize",K),window.addEventListener("popstate",G),I="onscrollend"in window,I?e.addEventListener("scrollend",V):e.addEventListener("scroll",J,{passive:!0})}function st(){h.clear(),e.removeEventListener("scroll",H),window.removeEventListener("resize",K),window.removeEventListener("popstate",G),I?e.removeEventListener("scrollend",V):($&&window.clearTimeout($),e.removeEventListener("scroll",J)),g!==null&&(window.clearTimeout(g),g=null),S!==null&&(window.clearTimeout(S),S=null)}function at(t){L=t,k=Array.from(new Set(L.flatMap(o=>o.tags||[]))).sort((o,s)=>o.localeCompare(s)),Z(),q(),Y(b,()=>U()),window.setTimeout(j,N)}return{init:nt,destroy:st,setItems:at,events:h}}exports.createGridList=ut;exports.findBestBlockSize=W;exports.findNaiveBlockSize=ct;

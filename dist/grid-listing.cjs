"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const x=(c,t,e,i,s,a)=>{const o=Math.max(1,Math.ceil((c+s)/(e*a+s))),l=Math.max(o,Math.floor((c+s)/(e/a+s))),r=Math.max(1,Math.ceil((t+s)/(i*a+s))),d=Math.max(r,Math.floor((t+s)/(i/a+s))),n=s>0?Math.floor(c/s)+1:Number.POSITIVE_INFINITY,S=s>0?Math.floor(t/s)+1:Number.POSITIVE_INFINITY,p=Math.max(1,Math.floor(c)),E=Math.max(1,Math.floor(t)),y=Math.min(l,n,p),f=Math.min(d,S,E);return{cMin:o,cMax:y,rMin:r,rMax:f}},D=(c,t,e,i,s,a={})=>{const o=a.weightSize??1,l=a.weightAR??1,r=a.alpha??1.5,d=e/i,n=x(c,t,e,i,s,r),S=1,p=1,E=Math.min(n.cMax,a.maxCols??Number.POSITIVE_INFINITY),y=Math.min(n.rMax,a.maxRows??Number.POSITIVE_INFINITY);let f=null;const v=(h,u)=>{if(h<S||u<p||h>E||u>y)return;const M=c-(h-1)*s,b=t-(u-1)*s;if(M<=0||b<=0)return;const g=M/h,m=b/u;if(a.integerBlockSize&&(!Number.isInteger(g)||!Number.isInteger(m))||g<e/r||g>e*r||m<i/r||m>i*r)return;const w=Math.hypot((g-e)/e,(m-i)/i),T=Math.abs(g/m-d)/d,I=o*w+l*T;(!f||I<f.score)&&(f={width:g,height:m,cols:h,rows:u,score:I,sizeError:w,arError:T})};for(let h=n.cMin;h<=E;h++){const u=c-(h-1)*s;if(u<=0)break;const M=u/h;if(M<e/r||M>e*r)continue;const b=(t+s)/(s+M/d),g=new Set;for(let m=-2;m<=2;m++){const w=Math.round(b+m);w>=p&&w<=y&&g.add(w)}g.add(n.rMin),g.add(y);for(const m of g)v(h,m)}if(!f)for(let h=n.cMin;h<=E;h++)for(let u=n.rMin;u<=y;u++)v(h,u);if(!f)throw new Error("No feasible grid found with given settings/tolerance.");return f},z=(c,t,e,i,s)=>{const a=Math.max(1,Math.round(c/e)),o=Math.max(1,Math.round(t/i)),l=c-s*Math.max(0,a-1),r=t-s*Math.max(0,o-1),d=l/a,n=r/o;return{width:d,height:n,cols:a,rows:o}};class R{gridEl;headerEl;measureViewportEl;desiredBlockSize={width:400,height:300};gap=10;fadeOutDurationMs=200;staggerStepMs=75;fadeStaggerStepMs=50;initialResizeDelayFrames=2;initialScrollDelayMs=1750;filterScrollDelayMs=400;items=[];allTags=[];activeTags=new Set;tagChipsEl=null;hasDoneInitialScrollUpdate=!1;hasDoneInitialResize=!1;resizeDebounceTimer=null;fadeOutTimer=null;headerZIndexRaised=!1;state;headerRowIndex=0;constructor(t){this.gridEl=t.gridEl,this.headerEl=t.headerEl??null,this.measureViewportEl=t.measureViewportEl??null,t.desiredBlockSize&&(this.desiredBlockSize=t.desiredBlockSize),typeof t.gap=="number"&&(this.gap=t.gap),typeof t.fadeOutDurationMs=="number"&&(this.fadeOutDurationMs=t.fadeOutDurationMs),typeof t.staggerStepMs=="number"&&(this.staggerStepMs=t.staggerStepMs),typeof t.fadeStaggerStepMs=="number"&&(this.fadeStaggerStepMs=t.fadeStaggerStepMs),typeof t.initialResizeDelayFrames=="number"&&(this.initialResizeDelayFrames=t.initialResizeDelayFrames),typeof t.initialScrollDelayMs=="number"&&(this.initialScrollDelayMs=t.initialScrollDelayMs),typeof t.filterScrollDelayMs=="number"&&(this.filterScrollDelayMs=t.filterScrollDelayMs)}setItems(t){this.items=t,this.allTags=Array.from(new Set(this.items.flatMap(e=>e.tags||[]))).sort((e,i)=>e.localeCompare(i)),this.initFromUrl(),this.renderTagChips(),this.delayFrames(this.initialResizeDelayFrames,()=>this.onResizeImmediate()),window.setTimeout(()=>this.onScroll(),this.initialScrollDelayMs)}init(){this.headerEl&&(this.tagChipsEl=document.createElement("div"),this.tagChipsEl.className="tags",this.headerEl.appendChild(this.tagChipsEl)),this.syncCssVars(),this.gridEl.addEventListener("scroll",()=>this.onScroll(),{passive:!0}),window.addEventListener("resize",()=>this.onWindowResize())}destroy(){this.gridEl.removeEventListener("scroll",()=>this.onScroll()),window.removeEventListener("resize",()=>this.onWindowResize())}syncCssVars(){const t=document.documentElement.style;t.setProperty("--block-gap",`${this.gap}px`),t.setProperty("--fade-out-duration",`${this.fadeOutDurationMs}ms`);const i=Math.max(0,this.initialScrollDelayMs-250);t.setProperty("--header-fade-delay",`${i}ms`)}delayFrames(t,e){if(t<=0){e();return}requestAnimationFrame(()=>this.delayFrames(t-1,e))}setLayout(t,e){this.state=D(t,e,this.desiredBlockSize.width,this.desiredBlockSize.height,this.gap),this.headerRowIndex=1;const i=document.documentElement.style;i.setProperty("--block-width",`${this.state.width}px`),i.setProperty("--block-height",`${this.state.height}px`),i.setProperty("--cols",String(this.state.cols)),i.setProperty("--rows",String(this.state.rows)),i.setProperty("--block-gap",`${this.gap}px`),i.setProperty("--header-row",`${this.headerRowIndex}`)}rebuildGrid(){if(!this.state)return;this.gridEl.innerHTML="";const t=document.createElement("div");t.className="row-spacer col-0",this.gridEl.appendChild(t);const e=this.items.filter(s=>this.activeTags.size===0?!0:(s.tags||[]).some(o=>this.activeTags.has(o)));e.forEach((s,a)=>{const o=Math.floor(a/this.state.cols),l=a%this.state.cols,r=this.createCard(s);r.dataset.row=`${o}`,r.dataset.column=`${l}`,r.classList.add(`row-${o}`),r.classList.add(`col-${l}`);const S=(o%2===0?l:this.state.cols-1-l)*this.staggerStepMs,p=a*this.fadeStaggerStepMs;r.style.transitionDelay=`${S}ms`,r.style.setProperty("--fade-delay",`${p}ms`),r.classList.add("fade-in"),this.gridEl.appendChild(r)});const i=Math.ceil(e.length/this.state.cols)+1;for(let s=0;s<i;s++){const a=document.createElement("div");a.className="snap-block",a.dataset.row=`${s}`,a.style.top=`${s*(this.state.height+this.gap)}px`,this.gridEl.appendChild(a)}}createCard(t){const e=t.title,s=(Array.isArray(t.thumbnails)?t.thumbnails:[])[0],a=(t.tags||[]).sort((l,r)=>l.localeCompare(r)),o=document.createElement("div");return o.className="block",o.innerHTML=`
      ${s?`<div class="media"><img class="thumb" src="${s}" alt="${e}"></div>`:""}
      <div class="content block-border">
        <div class="info">
          <h3>${e}</h3>
        </div>
        <div class="tags">
          ${a.map(l=>`<button class="tag${this.activeTags.has(l)?" active":""}" data-tag="${l}">${l}</button>`).join("")}
        </div>
      </div>
      <svg class="checker-border" xmlns="http://www.w3.org/2000/svg">
        <rect class="dash black" />
        <rect class="dash white" />
      </svg>
    `,t.href&&o.addEventListener("click",()=>{window.location.href=t.href}),o.querySelectorAll(".tag").forEach(l=>{l.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation();const d=l.getAttribute("data-tag");d&&this.toggleTag(d)})}),o}onScroll(){this.updateAboveHeaderClasses(),this.hasDoneInitialScrollUpdate||this.scheduleRaiseHeaderZIndexAfterStagger(),this.hasDoneInitialScrollUpdate=!0}onResizeImmediate(){const t=this.measureViewportEl?.getBoundingClientRect();if(!t){console.warn("[grid] measureViewport element not found");return}this.setLayout(t.width,t.height),this.rebuildGrid(),this.hasDoneInitialScrollUpdate&&this.updateAboveHeaderClasses(),this.gridEl&&this.gridEl.scrollHeight>this.gridEl.clientHeight&&(this.setLayout(this.gridEl.clientWidth,t.height),this.rebuildGrid(),this.hasDoneInitialScrollUpdate&&this.updateAboveHeaderClasses()),this.hasDoneInitialResize||(this.hasDoneInitialResize=!0,document.body.classList.add("layout-ready"))}onWindowResize(){const t=this.measureViewportEl?.getBoundingClientRect();if(!t)return;this.setLayout(t.width,t.height),this.gridEl.innerHTML="";const e=document.createElement("div");e.className="row-spacer col-0",this.gridEl.appendChild(e),this.resizeDebounceTimer!==null&&window.clearTimeout(this.resizeDebounceTimer),this.resizeDebounceTimer=window.setTimeout(()=>{this.rebuildGrid(),this.hasDoneInitialScrollUpdate&&this.updateAboveHeaderClasses(),this.gridEl&&this.gridEl.scrollHeight>this.gridEl.clientHeight&&(this.setLayout(this.gridEl.clientWidth,t.height),this.rebuildGrid(),this.hasDoneInitialScrollUpdate&&this.updateAboveHeaderClasses()),this.resizeDebounceTimer=null},400)}updateAboveHeaderClasses(){if(!this.state)return;const t=this.state.height+this.gap,i=Math.round(this.gridEl.scrollTop/t)+this.headerRowIndex;this.gridEl.querySelectorAll(".block").forEach(a=>{parseInt(a.dataset.row||"0",10)<i?a.classList.add("above-header"):a.classList.remove("above-header")})}scheduleRaiseHeaderZIndexAfterStagger(){if(!this.headerEl||!this.state||this.headerZIndexRaised)return;const t=Array.from(this.gridEl.querySelectorAll(".row-0"));if(t.length===0){this.headerEl.style.zIndex="10",this.headerZIndexRaised=!0;return}const e=i=>{const s=i.trim();if(s.endsWith("ms"))return parseFloat(s);if(s.endsWith("s"))return parseFloat(s)*1e3;const a=parseFloat(s);return Number.isFinite(a)?a:0};t.forEach(i=>{const s=getComputedStyle(i),a=s.transitionDelay.split(",").map(r=>e(r)),o=s.transitionDuration.split(",").map(r=>e(r)),l=Math.max(a.length,o.length);for(let r=0;r<l;r++)a[r%a.length],o[r%o.length]})}renderTagChips(){this.tagChipsEl&&(this.tagChipsEl.innerHTML="",this.allTags.forEach(t=>{const e=document.createElement("button");e.type="button",e.className="tag",e.textContent=t,e.dataset.tag=t,this.activeTags.has(t)&&e.classList.add("active"),e.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),this.toggleTag(t)}),this.tagChipsEl.appendChild(e)}))}toggleTag(t){this.activeTags.has(t)?this.activeTags.delete(t):this.activeTags.add(t),this.renderTagChips(),this.hasDoneInitialScrollUpdate=!1,this.fadeOutBlocksThen(()=>this.onResizeImmediate()),window.setTimeout(()=>this.onScroll(),this.filterScrollDelayMs),this.syncUrl()}fadeOutBlocksThen(t){const e=Array.from(this.gridEl.querySelectorAll(".block"));if(e.length===0){t();return}this.fadeOutTimer!==null&&(window.clearTimeout(this.fadeOutTimer),this.fadeOutTimer=null);let i=0;e.forEach(a=>{const o=parseInt(a.dataset.row||"0",10),l=parseInt(a.dataset.column||"0",10),n=(o%2===0?l:this.state.cols-1-l)*this.fadeStaggerStepMs;a.style.setProperty("--fade-delay",`${n}ms`),a.classList.add("fade-out"),n>i&&(i=n)});const s=i+this.fadeOutDurationMs+20;this.fadeOutTimer=window.setTimeout(()=>{this.fadeOutTimer=null,t()},s)}syncUrl(){const t=new URLSearchParams(location.search),e=Array.from(this.activeTags);e.length?t.set("tags",e.join(",")):t.delete("tags");const i=t.toString(),s=i?`${location.pathname}?${i}`:location.pathname;history.pushState(null,"",s)}initFromUrl(){this.activeTags.clear();const e=new URLSearchParams(location.search).get("tags");e&&e.split(",").filter(Boolean).forEach(i=>this.activeTags.add(i)),window.addEventListener("popstate",()=>{this.initFromUrl(),this.renderTagChips(),this.fadeOutBlocksThen(()=>this.onResizeImmediate())})}}exports.GridList=R;exports.findBestBlockSize=D;exports.findNaiveBlockSize=z;

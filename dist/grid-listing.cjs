"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const x=(d,t,e,s,i,a)=>{const l=Math.max(1,Math.ceil((d+i)/(e*a+i))),r=Math.max(l,Math.floor((d+i)/(e/a+i))),o=Math.max(1,Math.ceil((t+i)/(s*a+i))),c=Math.max(o,Math.floor((t+i)/(s/a+i))),n=i>0?Math.floor(d/i)+1:Number.POSITIVE_INFINITY,w=i>0?Math.floor(t/i)+1:Number.POSITIVE_INFINITY,E=Math.max(1,Math.floor(d)),S=Math.max(1,Math.floor(t)),p=Math.min(r,n,E),g=Math.min(c,w,S);return{cMin:l,cMax:p,rMin:o,rMax:g}},D=(d,t,e,s,i,a={})=>{const l=a.weightSize??1,r=a.weightAR??1,o=a.alpha??1.5,c=e/s,n=x(d,t,e,s,i,o),w=1,E=1,S=Math.min(n.cMax,a.maxCols??Number.POSITIVE_INFINITY),p=Math.min(n.rMax,a.maxRows??Number.POSITIVE_INFINITY);let g=null;const v=(h,u)=>{if(h<w||u<E||h>S||u>p)return;const y=d-(h-1)*i,b=t-(u-1)*i;if(y<=0||b<=0)return;const f=y/h,m=b/u;if(a.integerBlockSize&&(!Number.isInteger(f)||!Number.isInteger(m))||f<e/o||f>e*o||m<s/o||m>s*o)return;const M=Math.hypot((f-e)/e,(m-s)/s),T=Math.abs(f/m-c)/c,I=l*M+r*T;(!g||I<g.score)&&(g={width:f,height:m,cols:h,rows:u,score:I,sizeError:M,arError:T})};for(let h=n.cMin;h<=S;h++){const u=d-(h-1)*i;if(u<=0)break;const y=u/h;if(y<e/o||y>e*o)continue;const b=(t+i)/(i+y/c),f=new Set;for(let m=-2;m<=2;m++){const M=Math.round(b+m);M>=E&&M<=p&&f.add(M)}f.add(n.rMin),f.add(p);for(const m of f)v(h,m)}if(!g)for(let h=n.cMin;h<=S;h++)for(let u=n.rMin;u<=p;u++)v(h,u);if(!g)throw new Error("No feasible grid found with given settings/tolerance.");return g},z=(d,t,e,s,i)=>{const a=Math.max(1,Math.round(d/e)),l=Math.max(1,Math.round(t/s)),r=d-i*Math.max(0,a-1),o=t-i*Math.max(0,l-1),c=r/a,n=o/l;return{width:c,height:n,cols:a,rows:l}};class R{gridEl;headerEl;measureViewportEl;desiredBlockSize={width:400,height:300};gap=10;fadeOutDurationMs=200;staggerStepMs=75;fadeStaggerStepMs=50;initialResizeDelayFrames=2;initialScrollDelayMs=1750;filterScrollDelayMs=400;items=[];allTags=[];activeTags=new Set;tagChipsEl=null;hasDoneInitialScrollUpdate=!1;hasDoneInitialResize=!1;resizeDebounceTimer=null;fadeOutTimer=null;headerZIndexRaised=!1;state;headerRowIndex=0;constructor(t){this.gridEl=t.gridEl,this.headerEl=t.headerEl??null,this.measureViewportEl=t.measureViewportEl??null,t.desiredBlockSize&&(this.desiredBlockSize=t.desiredBlockSize),typeof t.gap=="number"&&(this.gap=t.gap),typeof t.fadeOutDurationMs=="number"&&(this.fadeOutDurationMs=t.fadeOutDurationMs),typeof t.staggerStepMs=="number"&&(this.staggerStepMs=t.staggerStepMs),typeof t.fadeStaggerStepMs=="number"&&(this.fadeStaggerStepMs=t.fadeStaggerStepMs),typeof t.initialResizeDelayFrames=="number"&&(this.initialResizeDelayFrames=t.initialResizeDelayFrames),typeof t.initialScrollDelayMs=="number"&&(this.initialScrollDelayMs=t.initialScrollDelayMs),typeof t.filterScrollDelayMs=="number"&&(this.filterScrollDelayMs=t.filterScrollDelayMs)}setItems(t){this.items=t,this.allTags=Array.from(new Set(this.items.flatMap(e=>e.tags||[]))).sort((e,s)=>e.localeCompare(s)),this.initFromUrl(),this.renderTagChips(),this.delayFrames(this.initialResizeDelayFrames,()=>this.onResizeImmediate()),window.setTimeout(()=>this.onScroll(),this.initialScrollDelayMs)}init(){this.headerEl&&(this.tagChipsEl=document.createElement("div"),this.tagChipsEl.className="tags",this.headerEl.appendChild(this.tagChipsEl)),this.syncCssVars(),this.gridEl.addEventListener("scroll",()=>this.onScroll(),{passive:!0}),window.addEventListener("resize",()=>this.onWindowResize())}destroy(){this.gridEl.removeEventListener("scroll",()=>this.onScroll()),window.removeEventListener("resize",()=>this.onWindowResize())}syncCssVars(){const t=document.documentElement.style;t.setProperty("--block-gap",`${this.gap}px`),t.setProperty("--fade-out-duration",`${this.fadeOutDurationMs}ms`);const s=Math.max(0,this.initialScrollDelayMs-250);t.setProperty("--header-fade-delay",`${s}ms`)}delayFrames(t,e){if(t<=0){e();return}requestAnimationFrame(()=>this.delayFrames(t-1,e))}setLayout(t,e){this.state=D(t,e,this.desiredBlockSize.width,this.desiredBlockSize.height,this.gap),this.headerRowIndex=1;const s=document.documentElement.style;s.setProperty("--block-width",`${this.state.width}px`),s.setProperty("--block-height",`${this.state.height}px`),s.setProperty("--cols",String(this.state.cols)),s.setProperty("--rows",String(this.state.rows)),s.setProperty("--block-gap",`${this.gap}px`),s.setProperty("--header-row",`${this.headerRowIndex}`)}rebuildGrid(){if(!this.state)return;this.gridEl.innerHTML="";const t=document.createElement("div");t.className="row-spacer col-0",this.gridEl.appendChild(t),this.items.filter(s=>this.activeTags.size===0?!0:(s.tags||[]).some(a=>this.activeTags.has(a))).forEach((s,i)=>{const a=Math.floor(i/this.state.cols),l=i%this.state.cols,r=this.createCard(s);r.dataset.row=`${a}`,r.dataset.column=`${l}`,r.classList.add(`row-${a}`),r.classList.add(`col-${l}`);const n=(a%2===0?l:this.state.cols-1-l)*this.staggerStepMs,w=i*this.fadeStaggerStepMs;r.style.transitionDelay=`${n}ms`,r.style.setProperty("--fade-delay",`${w}ms`),r.classList.add("fade-in"),this.gridEl.appendChild(r)})}createCard(t){const e=t.title,i=(Array.isArray(t.thumbnails)?t.thumbnails:[])[0],a=(t.tags||[]).sort((r,o)=>r.localeCompare(o)),l=document.createElement("div");return l.className="block",l.innerHTML=`
      ${i?`<div class="media"><img class="thumb" src="${i}" alt="${e}"></div>`:""}
      <div class="content block-border">
        <div class="info">
          <h3>${e}</h3>
        </div>
        <div class="tags">
          ${a.map(r=>`<button class="tag${this.activeTags.has(r)?" active":""}" data-tag="${r}">${r}</button>`).join("")}
        </div>
      </div>
      <svg class="checker-border" xmlns="http://www.w3.org/2000/svg">
        <rect class="dash black" />
        <rect class="dash white" />
      </svg>
    `,t.href&&l.addEventListener("click",()=>{window.location.href=t.href}),l.querySelectorAll(".tag").forEach(r=>{r.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation();const c=r.getAttribute("data-tag");c&&this.toggleTag(c)})}),l}onScroll(){this.updateAboveHeaderClasses(),this.hasDoneInitialScrollUpdate||this.scheduleRaiseHeaderZIndexAfterStagger(),this.hasDoneInitialScrollUpdate=!0}onResizeImmediate(){const t=this.measureViewportEl?.getBoundingClientRect();if(!t){console.warn("[grid] measureViewport element not found");return}this.setLayout(t.width,t.height),this.rebuildGrid(),this.hasDoneInitialScrollUpdate&&this.updateAboveHeaderClasses(),this.gridEl&&this.gridEl.scrollHeight>this.gridEl.clientHeight&&(this.setLayout(this.gridEl.clientWidth,t.height),this.rebuildGrid(),this.hasDoneInitialScrollUpdate&&this.updateAboveHeaderClasses()),this.hasDoneInitialResize||(this.hasDoneInitialResize=!0,document.body.classList.add("layout-ready"))}onWindowResize(){const t=this.measureViewportEl?.getBoundingClientRect();if(!t)return;this.setLayout(t.width,t.height),this.gridEl.innerHTML="";const e=document.createElement("div");e.className="row-spacer col-0",this.gridEl.appendChild(e),this.resizeDebounceTimer!==null&&window.clearTimeout(this.resizeDebounceTimer),this.resizeDebounceTimer=window.setTimeout(()=>{this.rebuildGrid(),this.hasDoneInitialScrollUpdate&&this.updateAboveHeaderClasses(),this.gridEl&&this.gridEl.scrollHeight>this.gridEl.clientHeight&&(this.setLayout(this.gridEl.clientWidth,t.height),this.rebuildGrid(),this.hasDoneInitialScrollUpdate&&this.updateAboveHeaderClasses()),this.resizeDebounceTimer=null},400)}updateAboveHeaderClasses(){if(!this.state)return;const t=this.state.height+this.gap,s=Math.round(this.gridEl.scrollTop/t)+this.headerRowIndex;this.gridEl.querySelectorAll(".block").forEach(a=>{parseInt(a.dataset.row||"0",10)<s?a.classList.add("above-header"):a.classList.remove("above-header")})}scheduleRaiseHeaderZIndexAfterStagger(){if(!this.headerEl||!this.state||this.headerZIndexRaised)return;const t=Array.from(this.gridEl.querySelectorAll(".row-0"));if(t.length===0){this.headerEl.style.zIndex="10",this.headerZIndexRaised=!0;return}const e=s=>{const i=s.trim();if(i.endsWith("ms"))return parseFloat(i);if(i.endsWith("s"))return parseFloat(i)*1e3;const a=parseFloat(i);return Number.isFinite(a)?a:0};t.forEach(s=>{const i=getComputedStyle(s),a=i.transitionDelay.split(",").map(o=>e(o)),l=i.transitionDuration.split(",").map(o=>e(o)),r=Math.max(a.length,l.length);for(let o=0;o<r;o++)a[o%a.length],l[o%l.length]})}renderTagChips(){this.tagChipsEl&&(this.tagChipsEl.innerHTML="",this.allTags.forEach(t=>{const e=document.createElement("button");e.type="button",e.className="tag",e.textContent=t,e.dataset.tag=t,this.activeTags.has(t)&&e.classList.add("active"),e.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.toggleTag(t)}),this.tagChipsEl.appendChild(e)}))}toggleTag(t){this.activeTags.has(t)?this.activeTags.delete(t):this.activeTags.add(t),this.renderTagChips(),this.hasDoneInitialScrollUpdate=!1,this.fadeOutBlocksThen(()=>this.onResizeImmediate()),window.setTimeout(()=>this.onScroll(),this.filterScrollDelayMs),this.syncUrl()}fadeOutBlocksThen(t){const e=Array.from(this.gridEl.querySelectorAll(".block"));if(e.length===0){t();return}this.fadeOutTimer!==null&&(window.clearTimeout(this.fadeOutTimer),this.fadeOutTimer=null);let s=0;e.forEach(a=>{const l=parseInt(a.dataset.row||"0",10),r=parseInt(a.dataset.column||"0",10),n=(l%2===0?r:this.state.cols-1-r)*this.fadeStaggerStepMs;a.style.setProperty("--fade-delay",`${n}ms`),a.classList.add("fade-out"),n>s&&(s=n)});const i=s+this.fadeOutDurationMs+20;this.fadeOutTimer=window.setTimeout(()=>{this.fadeOutTimer=null,t()},i)}syncUrl(){const t=new URLSearchParams(location.search),e=Array.from(this.activeTags);e.length?t.set("tags",e.join(",")):t.delete("tags");const s=t.toString(),i=s?`${location.pathname}?${s}`:location.pathname;history.pushState(null,"",i)}initFromUrl(){this.activeTags.clear();const e=new URLSearchParams(location.search).get("tags");e&&e.split(",").filter(Boolean).forEach(s=>this.activeTags.add(s)),window.addEventListener("popstate",()=>{this.initFromUrl(),this.renderTagChips(),this.fadeOutBlocksThen(()=>this.onResizeImmediate())})}}exports.GridList=R;exports.findBestBlockSize=D;exports.findNaiveBlockSize=z;

"use strict";var z=Object.defineProperty;var R=(h,t,e)=>t in h?z(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var n=(h,t,e)=>R(h,typeof t!="symbol"?t+"":t,e);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const C=(h,t,e,s,i,a)=>{const l=Math.max(1,Math.ceil((h+i)/(e*a+i))),r=Math.max(l,Math.floor((h+i)/(e/a+i))),o=Math.max(1,Math.ceil((t+i)/(s*a+i))),u=Math.max(o,Math.floor((t+i)/(s/a+i))),d=i>0?Math.floor(h/i)+1:Number.POSITIVE_INFINITY,S=i>0?Math.floor(t/i)+1:Number.POSITIVE_INFINITY,b=Math.max(1,Math.floor(h)),E=Math.max(1,Math.floor(t)),y=Math.min(r,d,b),p=Math.min(u,S,E);return{cMin:l,cMax:y,rMin:o,rMax:p}},x=(h,t,e,s,i,a={})=>{const l=a.weightSize??1,r=a.weightAR??1,o=a.alpha??1.5,u=e/s,d=C(h,t,e,s,i,o),S=1,b=1,E=Math.min(d.cMax,a.maxCols??Number.POSITIVE_INFINITY),y=Math.min(d.rMax,a.maxRows??Number.POSITIVE_INFINITY);let p=null;const T=(c,m)=>{if(c<S||m<b||c>E||m>y)return;const M=h-(c-1)*i,v=t-(m-1)*i;if(M<=0||v<=0)return;const g=M/c,f=v/m;if(a.integerBlockSize&&(!Number.isInteger(g)||!Number.isInteger(f))||g<e/o||g>e*o||f<s/o||f>s*o)return;const w=Math.hypot((g-e)/e,(f-s)/s),I=Math.abs(g/f-u)/u,D=l*w+r*I;(!p||D<p.score)&&(p={width:g,height:f,cols:c,rows:m,score:D,sizeError:w,arError:I})};for(let c=d.cMin;c<=E;c++){const m=h-(c-1)*i;if(m<=0)break;const M=m/c;if(M<e/o||M>e*o)continue;const v=(t+i)/(i+M/u),g=new Set;for(let f=-2;f<=2;f++){const w=Math.round(v+f);w>=b&&w<=y&&g.add(w)}g.add(d.rMin),g.add(y);for(const f of g)T(c,f)}if(!p)for(let c=d.cMin;c<=E;c++)for(let m=d.rMin;m<=y;m++)T(c,m);if(!p)throw new Error("No feasible grid found with given settings/tolerance.");return p},k=(h,t,e,s,i)=>{const a=Math.max(1,Math.round(h/e)),l=Math.max(1,Math.round(t/s)),r=h-i*Math.max(0,a-1),o=t-i*Math.max(0,l-1),u=r/a,d=o/l;return{width:u,height:d,cols:a,rows:l}};class L{constructor(t){n(this,"gridEl");n(this,"headerEl");n(this,"measureViewportEl");n(this,"desiredBlockSize",{width:400,height:300});n(this,"gap",10);n(this,"fadeOutDurationMs",200);n(this,"staggerStepMs",75);n(this,"fadeStaggerStepMs",50);n(this,"initialResizeDelayFrames",2);n(this,"initialScrollDelayMs",1750);n(this,"filterScrollDelayMs",400);n(this,"items",[]);n(this,"allTags",[]);n(this,"activeTags",new Set);n(this,"tagChipsEl",null);n(this,"hasDoneInitialScrollUpdate",!1);n(this,"hasDoneInitialResize",!1);n(this,"resizeDebounceTimer",null);n(this,"fadeOutTimer",null);n(this,"headerZIndexRaised",!1);n(this,"state");n(this,"headerRowIndex",0);this.gridEl=t.gridEl,this.headerEl=t.headerEl??null,this.measureViewportEl=t.measureViewportEl??null,t.desiredBlockSize&&(this.desiredBlockSize=t.desiredBlockSize),typeof t.gap=="number"&&(this.gap=t.gap),typeof t.fadeOutDurationMs=="number"&&(this.fadeOutDurationMs=t.fadeOutDurationMs),typeof t.staggerStepMs=="number"&&(this.staggerStepMs=t.staggerStepMs),typeof t.fadeStaggerStepMs=="number"&&(this.fadeStaggerStepMs=t.fadeStaggerStepMs),typeof t.initialResizeDelayFrames=="number"&&(this.initialResizeDelayFrames=t.initialResizeDelayFrames),typeof t.initialScrollDelayMs=="number"&&(this.initialScrollDelayMs=t.initialScrollDelayMs),typeof t.filterScrollDelayMs=="number"&&(this.filterScrollDelayMs=t.filterScrollDelayMs)}setItems(t){this.items=t,this.allTags=Array.from(new Set(this.items.flatMap(e=>e.tags||[]))).sort((e,s)=>e.localeCompare(s)),this.initFromUrl(),this.renderTagChips(),this.delayFrames(this.initialResizeDelayFrames,()=>this.onResizeImmediate()),window.setTimeout(()=>this.onScroll(),this.initialScrollDelayMs)}init(){this.headerEl&&(this.tagChipsEl=document.createElement("div"),this.tagChipsEl.className="tags",this.headerEl.appendChild(this.tagChipsEl)),this.syncCssVars(),this.gridEl.addEventListener("scroll",()=>this.onScroll(),{passive:!0}),window.addEventListener("resize",()=>this.onWindowResize())}destroy(){this.gridEl.removeEventListener("scroll",()=>this.onScroll()),window.removeEventListener("resize",()=>this.onWindowResize())}syncCssVars(){const t=document.documentElement.style;t.setProperty("--block-gap",`${this.gap}px`),t.setProperty("--fade-out-duration",`${this.fadeOutDurationMs}ms`);const s=Math.max(0,this.initialScrollDelayMs-250);t.setProperty("--header-fade-delay",`${s}ms`)}delayFrames(t,e){if(t<=0){e();return}requestAnimationFrame(()=>this.delayFrames(t-1,e))}setLayout(t,e){this.state=x(t,e,this.desiredBlockSize.width,this.desiredBlockSize.height,this.gap),this.headerRowIndex=1;const s=document.documentElement.style;s.setProperty("--block-width",`${this.state.width}px`),s.setProperty("--block-height",`${this.state.height}px`),s.setProperty("--cols",String(this.state.cols)),s.setProperty("--rows",String(this.state.rows)),s.setProperty("--block-gap",`${this.gap}px`),s.setProperty("--header-row",`${this.headerRowIndex}`)}rebuildGrid(){if(!this.state)return;this.gridEl.innerHTML="";const t=document.createElement("div");t.className="row-spacer col-0",this.gridEl.appendChild(t),this.items.filter(s=>this.activeTags.size===0?!0:(s.tags||[]).some(a=>this.activeTags.has(a))).forEach((s,i)=>{const a=Math.floor(i/this.state.cols),l=i%this.state.cols,r=this.createCard(s);r.dataset.row=`${a}`,r.dataset.column=`${l}`,r.classList.add(`row-${a}`),r.classList.add(`col-${l}`);const d=(a%2===0?l:this.state.cols-1-l)*this.staggerStepMs,S=i*this.fadeStaggerStepMs;r.style.transitionDelay=`${d}ms`,r.style.setProperty("--fade-delay",`${S}ms`),r.classList.add("fade-in"),this.gridEl.appendChild(r)})}createCard(t){const e=t.title,i=(Array.isArray(t.thumbnails)?t.thumbnails:[])[0],a=(t.tags||[]).sort((r,o)=>r.localeCompare(o)),l=document.createElement("div");return l.className="block",l.innerHTML=`
      ${i?`<div class="media"><img class="thumb" src="${i}" alt="${e}"></div>`:""}
      <div class="content block-border">
        <div class="info">
          <h3>${e}</h3>
        </div>
        <div class="tags">
          ${a.map(r=>`<button class="tag${this.activeTags.has(r)?" active":""}" data-tag="${r}">${r}</button>`).join("")}
        </div>
      </div>
      <svg class="checker-border" xmlns="http://www.w3.org/2000/svg">
        <rect class="dash black" />
        <rect class="dash white" />
      </svg>
    `,t.href&&l.addEventListener("click",()=>{window.location.href=t.href}),l.querySelectorAll(".tag").forEach(r=>{r.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation();const u=r.getAttribute("data-tag");u&&this.toggleTag(u)})}),l}onScroll(){this.updateAboveHeaderClasses(),this.hasDoneInitialScrollUpdate||this.scheduleRaiseHeaderZIndexAfterStagger(),this.hasDoneInitialScrollUpdate=!0}onResizeImmediate(){var e;const t=(e=this.measureViewportEl)==null?void 0:e.getBoundingClientRect();if(!t){console.warn("[grid] measureViewport element not found");return}this.setLayout(t.width,t.height),this.rebuildGrid(),this.hasDoneInitialScrollUpdate&&this.updateAboveHeaderClasses(),this.gridEl&&this.gridEl.scrollHeight>this.gridEl.clientHeight&&(this.setLayout(this.gridEl.clientWidth,t.height),this.rebuildGrid(),this.hasDoneInitialScrollUpdate&&this.updateAboveHeaderClasses()),this.hasDoneInitialResize||(this.hasDoneInitialResize=!0,document.body.classList.add("layout-ready"))}onWindowResize(){var s;const t=(s=this.measureViewportEl)==null?void 0:s.getBoundingClientRect();if(!t)return;this.setLayout(t.width,t.height),this.gridEl.innerHTML="";const e=document.createElement("div");e.className="row-spacer col-0",this.gridEl.appendChild(e),this.resizeDebounceTimer!==null&&window.clearTimeout(this.resizeDebounceTimer),this.resizeDebounceTimer=window.setTimeout(()=>{this.rebuildGrid(),this.hasDoneInitialScrollUpdate&&this.updateAboveHeaderClasses(),this.gridEl&&this.gridEl.scrollHeight>this.gridEl.clientHeight&&(this.setLayout(this.gridEl.clientWidth,t.height),this.rebuildGrid(),this.hasDoneInitialScrollUpdate&&this.updateAboveHeaderClasses()),this.resizeDebounceTimer=null},400)}updateAboveHeaderClasses(){if(!this.state)return;const t=this.state.height+this.gap,s=Math.round(this.gridEl.scrollTop/t)+this.headerRowIndex;this.gridEl.querySelectorAll(".block").forEach(a=>{parseInt(a.dataset.row||"0",10)<s?a.classList.add("above-header"):a.classList.remove("above-header")})}scheduleRaiseHeaderZIndexAfterStagger(){if(!this.headerEl||!this.state||this.headerZIndexRaised)return;const t=Array.from(this.gridEl.querySelectorAll(".row-0"));if(t.length===0){this.headerEl.style.zIndex="10",this.headerZIndexRaised=!0;return}const e=s=>{const i=s.trim();if(i.endsWith("ms"))return parseFloat(i);if(i.endsWith("s"))return parseFloat(i)*1e3;const a=parseFloat(i);return Number.isFinite(a)?a:0};t.forEach(s=>{const i=getComputedStyle(s),a=i.transitionDelay.split(",").map(o=>e(o)),l=i.transitionDuration.split(",").map(o=>e(o)),r=Math.max(a.length,l.length);for(let o=0;o<r;o++)a[o%a.length],l[o%l.length]})}renderTagChips(){this.tagChipsEl&&(this.tagChipsEl.innerHTML="",this.allTags.forEach(t=>{const e=document.createElement("button");e.type="button",e.className="tag",e.textContent=t,e.dataset.tag=t,this.activeTags.has(t)&&e.classList.add("active"),e.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.toggleTag(t)}),this.tagChipsEl.appendChild(e)}))}toggleTag(t){this.activeTags.has(t)?this.activeTags.delete(t):this.activeTags.add(t),this.renderTagChips(),this.hasDoneInitialScrollUpdate=!1,this.fadeOutBlocksThen(()=>this.onResizeImmediate()),window.setTimeout(()=>this.onScroll(),this.filterScrollDelayMs),this.syncUrl()}fadeOutBlocksThen(t){const e=Array.from(this.gridEl.querySelectorAll(".block"));if(e.length===0){t();return}this.fadeOutTimer!==null&&(window.clearTimeout(this.fadeOutTimer),this.fadeOutTimer=null);let s=0;e.forEach(a=>{const l=parseInt(a.dataset.row||"0",10),r=parseInt(a.dataset.column||"0",10),d=(l%2===0?r:this.state.cols-1-r)*this.fadeStaggerStepMs;a.style.setProperty("--fade-delay",`${d}ms`),a.classList.add("fade-out"),d>s&&(s=d)});const i=s+this.fadeOutDurationMs+20;this.fadeOutTimer=window.setTimeout(()=>{this.fadeOutTimer=null,t()},i)}syncUrl(){const t=new URLSearchParams(location.search),e=Array.from(this.activeTags);e.length?t.set("tags",e.join(",")):t.delete("tags");const s=t.toString(),i=s?`${location.pathname}?${s}`:location.pathname;history.pushState(null,"",i)}initFromUrl(){this.activeTags.clear();const e=new URLSearchParams(location.search).get("tags");e&&e.split(",").filter(Boolean).forEach(s=>this.activeTags.add(s)),window.addEventListener("popstate",()=>{this.initFromUrl(),this.renderTagChips(),this.fadeOutBlocksThen(()=>this.onResizeImmediate())})}}exports.GridList=L;exports.findBestBlockSize=x;exports.findNaiveBlockSize=k;
